/*! experimentalSHMUP 10-02-2014 */
function logPlay(){_gaq.push(["_trackEvent","Button","Play"])}function start(){var a=new Date;window.app=new SL.Game({canvas:document.getElementById("GameCanvas")}),app.camera=new SL.Camera(app.sctx,new SL.Vec2(400,300)),app.assetCollection=new SL.AssetCollection("res/assets.json",app,function(){_gaq.push(["_trackEvent","Game","Load","",(new Date-a)/1e3]),$(".canvas-container").append(domjs.build(templates.modal));var b=new SL.Scene("loading",[],function(){});b.addEntity({percentLoaded:0,textLocation:new SL.Vec2(400,300),update:function(){100===app.assetCollection.getLoadedPercentage()&&app.transitionScene("menu")},draw:function(a){a.clearRect(0,0,800,600),app.camera.drawText({location:app.screenSize.getScaled(.5),align:"center",text:app.assetCollection.getLoadedPercentage().toFixed()+"%",color:"green",font:"72px Arial"})}});var c=new SL.Scene("menu",[],function(){var a=$(".modal");a.append(domjs.build(templates.menu)),$(".menu .button").on("click",function(){a.empty(),a.off(),app.transitionScene($(this).attr("id"))})}),d=new SL.Scene("settings",[],function(){var a=$(".modal");a.append(domjs.build(templates.settings)),$(".menu .button").on("click",function(){var b=$(this).attr("id");"menu"===b&&(a.empty(),a.off(),app.transitionScene(b))}),app.currentScene.addEntity({update:function(){},draw:function(a){a.clearRect(0,0,800,600)}})}),e=new SL.Scene("about",[],function(){var a=$(".modal");a.append(domjs.build(templates.about)),$(".menu .button").on("click",function(){a.empty(),a.off(),app.transitionScene($(this).attr("id"))}),app.currentScene.addEntity({update:function(){},draw:function(a){a.clearRect(0,0,800,600)}})}),f=new SL.Scene("game",[],function(){var a=app.assetCollection.getImage("bg-1");app.currentScene.addEntity({update:function(){app.currentScene.getEntitiesByTag("SHIP")[0]&&(app.camera.offset=new SL.Vec2(400,300).translate(app.currentScene.getEntitiesByTag("SHIP")[0].collider.origin.getScaled(-1)))},draw:function(){var b=new SL.Vec2(0,0);app.currentScene.getEntitiesByTag("SHIP")[0]&&(b=app.currentScene.getEntitiesByTag("SHIP")[0].collider.origin.clone()),app.camera.drawImage({image:a,location:b})}}),test()});app.addScene(b),app.addScene(c),app.addScene(f),app.addScene(d),app.addScene(e),app.transitionScene("loading"),app.start()})}function Ship(a){var b=this,c=app.assetCollection.assets.blueprints[a.blueprint];b.tag="SHIP",c.ship=b,b.blueprint=new Blueprint(c),b.messageBus={ENGINE:[],BLASTER:[],ATTITUDE:[],TARGET:[]},b.collider=new SL.Circle(a.location,b.blueprint.size),b.rotation=90,b.velocity=new SL.Vec2(0,0),b.angularVelocity=0,b.momentum=0,b.weight=b.blueprint.weight,b.maxSpeed=0,b.team=0,b.update=function(){var a;for(var c in b.messageBus){for(var d=0;d<b.messageBus[c].length;d++)for(var e=0;e<b.blueprint.slots.length;e++)c===b.blueprint.slots[e].type&&b.blueprint.slots[e].module&&b.blueprint.slots[e].module.message(b.messageBus[c][d]);b.messageBus[c]=[]}for(b.blueprint.update(),c=0;c<b.blueprint.slots.length;c++)b.blueprint.slots[c].module&&b.blueprint.slots[c].module.update();a=SL.Tween.quadIn(b.maxSpeed,b.momentum/(b.weight*MOMENTUM_PER_TON)),b.velocity=SL.Vec2.fromPolar(a,b.rotation),b.collider.origin.translate(b.velocity.getScaled(app.deltaTime)),b.angularVelocity+=-b.angularVelocity/ANGULAR_DRAG_MODIFIER*(b.weight/100),b.rotation+=b.angularVelocity*app.deltaTime,b.momentum-=MOMENTUM_DECAY_RATE*app.deltaTime,b.momentum=SL.clamp(b.momentum,0,b.weight*MOMENTUM_PER_TON)},b.draw=function(){app.camera.drawCircle({origin:b.collider.origin,radius:b.collider.radius,lineColor:"red",lineWidth:2}),b.blueprint.draw();for(var a=0;a<b.blueprint.slots.length;a++)b.blueprint.slots[a].module&&b.blueprint.slots[a].module.draw();app.camera.drawText({text:b.velocity.x.toFixed(2)+"  "+b.velocity.y.toFixed(2),location:b.collider.origin.getTranslated(new SL.Vec2(0,40)),align:"center"}),app.camera.drawText({text:b.angularVelocity.toFixed(2),location:b.collider.origin.getTranslated(new SL.Vec2(0,55)),align:"center"})},b.message=function(a,c){b.messageBus[a].push(c)},b.setSlotModule=function(a,c){a.isModuleCompatible(c)&&(a.module?b.weight-a.module.weight+c.weight<=b.blueprint.maxWeight&&(b.weight=b.weight-a.module.weight+c.weight,a.module=c,a.module.ship=b,a.module.slot=a,b.evaluateMaxSpeed()):b.weight+c.weight<=b.blueprint.maxWeight&&(b.weight=b.weight+c.weight,a.module=c,a.module.ship=b,a.module.slot=a,b.evaluateMaxSpeed()))},b.setModuleProjectile=function(a,b){a.isProjectileCompatible(b)&&(a.projectile=b)},b.impulse=function(a){b.momentum+=a*app.deltaTime},b.angularImpulse=function(a){b.angularVelocity+=a*(1/b.weight)},b.evaluateMaxSpeed=function(){for(var a=0;a<b.blueprint.slots.length;a++)"ENGINE"===b.blueprint.slots[a].type&&b.blueprint.slots[a].module&&(b.maxSpeed+=b.blueprint.slots[a].module.speed);b.maxSpeed/=b.weight/100}}function Blueprint(a){var b,c=this;for(var d in a)c[d]=a[d];for(b=c.slots,c.slots=[],d=0;d<b.length;d++)c.slots.push(new Slot(b[d])),c.slots[d].blueprint=c;c.image=app.assetCollection.getImage(c.name+"-hull.png"),c.update=function(){},c.draw=function(){app.camera.drawImage({image:c.image,location:c.ship.collider.origin,angle:c.ship.rotation})}}function Slot(a){var b=this;for(var c in a)b[c]=a[c];b.location=new SL.Vec2(b.location.x,b.location.y),b.module=null,b.isModuleCompatible=function(a){return"DYNAMIC"===b.type||b.type===a.type}}function Module(a){var b=this,c=function(){b.BLASTER=function(){b.timeToFire=0,b.currentClip=b.clip,b.state="IDLE",b.update=function(){for(var a=0;a<b.messages.length;a++)"FIRE"===b.messages[a]&&"IDLE"===b.state&&(b.state="FIRING");b.messages=[],"IDLE"!==b.state&&("RELOAD"===b.state&&(b.timeToFire-=app.deltaTime,b.timeToFire<=0&&(b.timeToFire=0,b.currentClip=b.clip,b.state="IDLE")),"FIRING"===b.state&&b.currentClip>0&&(b.timeToFire>0?b.timeToFire-=app.deltaTime:(b.currentClip--,b.timeToFire=b.fireInterval,b.fire(),b.currentClip<1&&(b.state="RELOAD",b.timeToFire=b.reloadTime))))},b.draw=function(){app.camera.drawImage({image:b.image,location:b.ship.collider.origin.getTranslated(b.slot.location).rotate(b.ship.collider.origin,b.ship.rotation),angle:b.ship.rotation})},b.fire=function(){}},b.MISSILE=function(){b.timeToFire=0,b.currentClip=b.clip,b.state="IDLE",b.update=function(){for(var a=0;a<b.messages.length;a++)"FIRE"===b.messages[a]&&"IDLE"===b.state&&(b.state="FIRING");b.messages=[],"IDLE"!==b.state&&("RELOAD"===b.state&&(b.timeToFire-=app.deltaTime,b.timeToFire<=0&&(b.timeToFire=0,b.currentClip=b.clip,b.state="IDLE")),"FIRING"===b.state&&b.currentClip>0&&(b.timeToFire>0?b.timeToFire-=app.deltaTime:(b.currentClip--,b.timeToFire=b.fireInterval,b.fire(),b.currentClip<1&&(b.state="RELOAD",b.timeToFire=b.reloadTime))))},b.draw=function(){app.camera.drawImage({image:b.image,location:b.ship.collider.origin.getTranslated(b.slot.location).rotate(b.ship.collider.origin,b.ship.rotation),angle:b.ship.rotation})},b.fire=function(){}},b.ENGINE=function(){b.state="IDLE",b.update=function(){for(var a=0;a<b.messages.length;a++)"TOGGLE"===b.messages[a]&&(b.state="IDLE"===b.state?"IMPULSE":"IDLE");b.messages=[],"IMPULSE"===b.state&&b.ship.impulse(b.impulse)},b.draw=function(){app.camera.drawImage({image:b.image,location:b.ship.collider.origin.getTranslated(b.slot.location).rotate(b.ship.collider.origin,b.ship.rotation),angle:b.ship.rotation})}},b.UTILITY=function(){b.update=function(){},b.draw=function(){}},b.ATTITUDE=function(){b.state=0,b.update=function(){for(var a=0;a<b.messages.length;a++)b.state=parseInt(b.messages[a]);b.messages=[],b.state>0&&(1===b.state?b.ship.angularImpulse(b.impulse):b.ship.angularImpulse(-b.impulse))},b.draw=function(){app.camera.drawCircle({origin:b.ship.collider.origin.getTranslated(b.slot.location).rotate(b.ship.collider.origin,b.ship.rotation),radius:3,lineColor:"green"})}},b.isProjectileCompatible=function(a){return b.projectileType===a.type},b[b.type]()};for(var d in a)b[d]=a[d];b.image=app.assetCollection.getImage(b.name),b.messages=[],b.message=function(a){b.messages.push(a)},c()}function Projectile(a){var b=this;for(var c in a)b[c]=a[c];b.image=app.assetCollection.getImage("img/projectiles/"+b.name);var d=function(){b.SLUG=function(){b.update=function(){var a=app.currentScene.getEntitiesByTag("SHIP");b.location.translate(b.velocity.getScaled(app.deltaTime));for(var c=0;c<a.length;c++)a[c].team!==b.team&&b.collider.intersects(a[c].collider)&&app.currentScene.removeEntity(b)},b.draw=function(){app.camera.drawImage({image:b.image,location:b.location,angle:b.angle})}},b.MISSILE=function(){b.update=function(){var a=app.currentScene.getEntitiesByTag("SHIP"),c=b.target.collider.origin.angleBetween(b.collider.origin);SL.Tween.lerp(b.angle,c,(b.angle+b.rotationSpeed*app.deltaTime)/Math.abs(c-b.angle)),b.location.translateAlongRotation(b.speed*app.deltaTime,b.angle);for(var d=0;d<a.length;d++)a[d].team!==b.team&&b.collider.intersects(a[d].collider)&&app.currentScene.removeEntity(b)},b.draw=function(){app.camera.drawImage({image:b.image,location:b.location,angle:b.angle})}},b[b.type]()};d()}function test(){var a=new Ship({blueprint:"fighter",location:new SL.Vec2(0,0)}),b=new Ship({blueprint:"fighter",location:new SL.Vec2(100,0)});a.testID=0,b.testID=1,a.setSlotModule(a.blueprint.slots[0],new Module(app.assetCollection.assets.modules.BLASTER.fighter)),a.setModuleProjectile(a.blueprint.slots[0].module,new Projectile(app.assetCollection.assets.projectiles.SLUG.uranium)),a.setSlotModule(a.blueprint.slots[1],new Module(app.assetCollection.assets.modules.ENGINE.fighter)),a.setSlotModule(a.blueprint.slots[2],new Module(app.assetCollection.assets.modules.ATTITUDE.fighter)),a.setSlotModule(a.blueprint.slots[3],new Module(app.assetCollection.assets.modules.ATTITUDE.fighter)),b.setSlotModule(b.blueprint.slots[0],new Module(app.assetCollection.assets.modules.MISSILE.fighter)),b.setModuleProjectile(b.blueprint.slots[0].module,new Projectile(app.assetCollection.assets.projectiles.MISSILE.heat)),b.setSlotModule(b.blueprint.slots[1],new Module(app.assetCollection.assets.modules.ENGINE.fighter)),b.setSlotModule(b.blueprint.slots[2],new Module(app.assetCollection.assets.modules.ATTITUDE.fighter)),b.setSlotModule(b.blueprint.slots[3],new Module(app.assetCollection.assets.modules.ATTITUDE.fighter)),app.currentScene.addEntity(a),app.currentScene.addEntity(b)}SL=sugarLab;var CAMERA_OFFSET=new SL.Vec2(0,0),BASE_ENGINE_SPEED=50,MOMENTUM_PER_TON=10,MOMENTUM_DECAY_RATE=200,ANGULAR_DRAG_MODIFIER=10;